<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.toast.document.dao.ManageFormDAO">

    <!-- 게시글 목록 -->
    <select id="allCount" resultType="int">
        SELECT CEIL(COUNT(form_idx) / #{param1}) FROM form
        <where>
            <if test="param3 != null and !param3.equals('') and param2.equals('form_subject')">
                form_subject LIKE CONCAT('%', #{param3}, '%')
            </if>
            <if test="param3 != null and !param3.equals('') and param2.equals('form_content')">
                form_content LIKE CONCAT('%', #{param3}, '%')
            </if>
        </where>
    </select>

    <select id="countIdx" resultType="int">
        SELECT COUNT(form_idx) FROM form
        <where>
            <if test="param2 != null and !param2.equals('') and param1.equals('form_subject')">
                form_subject LIKE CONCAT('%', #{param2}, '%')
            </if>
            <if test="param2 != null and !param2.equals('') and param1.equals('form_content')">
                form_content LIKE CONCAT('%', #{param2}, '%')
            </if>
        </where>
    </select>

    <select id="list" resultType="com.toast.document.dto.ManageFormDTO">
        SELECT f.form_idx, f.form_subject,
            (SELECT l.dept_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 1) as 'dept_idx_1',
            (SELECT (SELECT d.dept_name FROM department d WHERE d.dept_idx = l.dept_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 1) as 'dept_name_1',
            (SELECT l.duty_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 1) as 'duty_idx_1',
            (SELECT (SELECT u.duty_name FROM duty u WHERE u.duty_idx = l.duty_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 1) as 'duty_name_1',
            (SELECT l.dept_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 2) as 'dept_idx_2',
            (SELECT (SELECT d.dept_name FROM department d WHERE d.dept_idx = l.dept_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 2) as 'dept_name_2',
            (SELECT l.duty_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 2) as 'duty_idx_2',
            (SELECT (SELECT u.duty_name FROM duty u WHERE u.duty_idx = l.duty_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 2) as 'duty_name_2',
            (SELECT l.dept_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 3) as 'dept_idx_3',
            (SELECT (SELECT d.dept_name FROM department d WHERE d.dept_idx = l.dept_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 3) as 'dept_name_3',
            (SELECT l.duty_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 3) as 'duty_idx_3',
            (SELECT (SELECT u.duty_name FROM duty u WHERE u.duty_idx = l.duty_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 3) as 'duty_name_3'
        FROM form f
        <where>
            <if test="param4 != null and !param4.equals('') and param3.equals('form_subject')">
                form_subject LIKE CONCAT('%', #{param4}, '%')
            </if>
            <if test="param4 != null and !param4.equals('') and param3.equals('form_content')">
                form_content LIKE CONCAT('%', #{param4}, '%')
            </if>
        </where>
        ORDER BY f.form_idx DESC LIMIT #{param1} OFFSET #{param2}
    </select>

    <select id="preview" resultType="String">
        SELECT form_content FROM form WHERE form_idx = #{param1}
    </select>

    <select id="detail" resultType="com.toast.document.dto.ManageFormDTO">
        SELECT f.form_idx, f.form_subject, f.form_content, f.form_handler_idx,
        (SELECT e.empl_name FROM employee e WHERE e.empl_idx = f.form_handler_idx) as 'empl_name',
        (SELECT l.dept_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 1) as 'dept_idx_1',
        (SELECT (SELECT d.dept_name FROM department d WHERE d.dept_idx = l.dept_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 1) as 'dept_name_1',
        (SELECT l.duty_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 1) as 'duty_idx_1',
        (SELECT (SELECT u.duty_name FROM duty u WHERE u.duty_idx = l.duty_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 1) as 'duty_name_1',
        (SELECT l.dept_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 2) as 'dept_idx_2',
        (SELECT (SELECT d.dept_name FROM department d WHERE d.dept_idx = l.dept_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 2) as 'dept_name_2',
        (SELECT l.duty_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 2) as 'duty_idx_2',
        (SELECT (SELECT u.duty_name FROM duty u WHERE u.duty_idx = l.duty_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 2) as 'duty_name_2',
        (SELECT l.dept_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 3) as 'dept_idx_3',
        (SELECT (SELECT d.dept_name FROM department d WHERE d.dept_idx = l.dept_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 3) as 'dept_name_3',
        (SELECT l.duty_idx FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 3) as 'duty_idx_3',
        (SELECT (SELECT u.duty_name FROM duty u WHERE u.duty_idx = l.duty_idx) FROM g_approval_line l WHERE l.form_idx = f.form_idx AND l.gline_order = 3) as 'duty_name_3'
        FROM form f WHERE f.form_idx = #{param1}
    </select>

</mapper>